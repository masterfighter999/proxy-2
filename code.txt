/
├── api/                        # Azure Functions backend (Node.js/JS or C#/Python supported)
│   └── negotiate/              # Negotiation/proxy function for Azure Voice Live API
│       ├── index.js            # Function main code (Node.js example)
│       └── function.json       # Function bindings/trigger config
├── host.json                   # Azure Functions global config
├── staticwebapp.config.json    # Static Web App config (routes, CORS, etc)
├── package.json                # Optional (if using npm for api dependencies)
├── public/                     # Static frontend files (optional, if serving a web UI)
│   └── index.html              # (optional)
└── README.md                   # (optional, for docs)


// /api/negotiate/index.js//
// Azure Static Web Apps function to negotiate with the Azure Voice Live API
const fetch = require('node-fetch');

module.exports = async function (context, req) {
    // You usually get these from environment variables
    const AZURE_VOICE_KEY = process.env.AZURE_VOICE_KEY;
    const AZURE_VOICE_REGION = process.env.AZURE_VOICE_REGION;

    if (!AZURE_VOICE_KEY || !AZURE_VOICE_REGION) {
        context.res = {
            status: 500,
            body: "Azure Voice API KEY or REGION not configured."
        };
        return;
    }

    // Optionally: require client authentication here if you want
    // const userToken = req.query.token || req.headers["authorization"];
    // if (!userToken) { ... }

    // Step 1: Get an Azure Voice API access token
    const tokenResp = await fetch(`https://${AZURE_VOICE_REGION}.api.cognitive.microsoft.com/sts/v1.0/issueToken`, {
        method: 'POST',
        headers: {
            'Ocp-Apim-Subscription-Key': AZURE_VOICE_KEY,
            'Content-Length': '0'
        }
    });

    if (!tokenResp.ok) {
        context.res = {
            status: 500,
            body: "Failed to get Azure Voice API token"
        };
        return;
    }

    const token = await tokenResp.text();

    // Step 2: Compose the websocket endpoint for Voice Live API
    // (Replace with actual endpoint if needed, check docs for region-specific)
    const wsUrl = `wss://${AZURE_VOICE_REGION}.api.speech.microsoft.com/voice/live/ws?Authorization=Bearer%20${encodeURIComponent(token)}`;

    context.res = {
        headers: {
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            url: wsUrl, // Frontend should connect directly to this
            token,      // Optionally send raw token if you want
            region: AZURE_VOICE_REGION
        })
    };
}


// /api/negotiate/function.json//
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "route": "negotiate",
      "methods": ["get", "post"]
    },
    {
      "type": "http",
      "direction": "out"
    }
  ]
}


//  /staticwebapp.config.json //
{
  "routes": [
    {
      "route": "/api/*",
      "allowedOrigins": ["*"]
    }
  ]
}


